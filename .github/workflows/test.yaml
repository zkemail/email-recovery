name: Account tests

on:
  workflow_call:
    inputs:
      restore-cache:
        type: boolean
        default: true
        required: false

      cache-key:
        type: string
        default: build-artifacts-${{ github.sha }}
        required: false

      cache-path:
        type: string
        default: |
          cache
          out
        required: false

      match-path:
        required: true
        type: string

      foundry-profile:
        default: default
        required: false
        type: string

      foundry-gas-limit:
        default: "18446744073709551615"
        required: false
        type: string

      foundry-memory-limit:
        default: 4294967295
        required: false
        type: number

      foundry-verbosity:
        default: 3
        required: false
        type: number

    secrets:
      MAINNET_RPC_URL:
        required: false
      TESTNET_RPC_URL:
        required: false

env:
  FOUNDRY_PROFILE: ${{ inputs.foundry-profile }}
  FOUNDRY_GAS_LIMIT: ${{ inputs.foundry-gas-limit }}
  FOUNDRY_MEMORY_LIMIT: ${{ inputs.foundry-memory-limit }}
  FOUNDRY_VERBOSITY: ${{ inputs.foundry-verbosity }}
  MAINNET_RPC_URL: ${{ secrets.MAINNET_RPC_URL }}
  TESTNET_RPC_URL: ${{ secrets.TESTNET_RPC_URL }}

jobs:
  default-account:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment

      - name: Restore the cached build and the node modules
        if: ${{ inputs.restore-cache }}
        uses: actions/cache/restore@v4
        with:
          key: ${{ inputs.cache-key }}
          path: ${{ inputs.cache-path }}

      - name: Test DEFAULT account
        run: forge test --threads 1 --match-path "${{ inputs.match-path }}"
        env:
          ACCOUNT_TYPE: DEFAULT

  safe-account:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment

      - name: Restore the cached build and the node modules
        if: ${{ inputs.restore-cache }}
        uses: actions/cache/restore@v4
        with:
          key: ${{ inputs.cache-key }}
          path: ${{ inputs.cache-path }}

      - name: Test SAFE account
        run: forge test --threads 1 --match-path "${{ inputs.match-path }}"
        env:
          ACCOUNT_TYPE: SAFE

  kernel-account:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment

      - name: Restore the cached build and the node modules
        if: ${{ inputs.restore-cache }}
        uses: actions/cache/restore@v4
        with:
          key: ${{ inputs.cache-key }}
          path: ${{ inputs.cache-path }}

      - name: Test KERNEL account
        run: forge test --threads 1 --match-path "${{ inputs.match-path }}"
        env:
          ACCOUNT_TYPE: KERNEL

  nexus-account:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment

      - name: Restore the cached build and the node modules
        if: ${{ inputs.restore-cache }}
        uses: actions/cache/restore@v4
        with:
          key: ${{ inputs.cache-key }}
          path: ${{ inputs.cache-path }}

      - name: Test NEXUS account
        run: forge test --threads 1 --match-path "${{ inputs.match-path }}"
        env:
          ACCOUNT_TYPE: NEXUS
